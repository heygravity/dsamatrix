<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BST Stabilizer | DSA Matrix</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='25' fill='%236366f1'/><circle cx='50' cy='50' r='20' fill='white'/></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --surface: #111111;
            --accent: #6366f1;
            --error: #ef4444;
            --success: #22c55e;
            --border: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: var(--bg);
            color: #efefef;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            display: flex;
            flex-direction: column;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .glass {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
        }

        /* --- Simplified Mode Transition Splash --- */
        #mode-splash {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        #mode-splash.active {
            opacity: 1;
            pointer-events: all;
        }

        @keyframes progress-load {
            0% { transform: scaleX(0); }
            100% { transform: scaleX(1); }
        }

        .splash-progress {
            height: 1px;
            width: 160px;
            background: rgba(255,255,255,0.05);
            margin-top: 1.5rem;
            overflow: hidden;
            position: relative;
        }

        .splash-progress-bar {
            position: absolute;
            top: 0; left: 0; height: 100%;
            width: 100%;
            background: white;
            transform-origin: left;
            transform: scaleX(0);
        }

        #mode-splash.active .splash-progress-bar {
            animation: progress-load 0.8s cubic-bezier(0.65, 0, 0.35, 1) forwards;
        }

        /* --- Toggle Switch --- */
        .mode-toggle {
            position: relative;
            width: 120px;
            height: 32px;
            background: #18181b;
            border-radius: 16px;
            padding: 4px;
            cursor: pointer;
            border: 1px solid var(--border);
        }

        @media (min-width: 768px) {
            .mode-toggle { width: 160px; height: 36px; border-radius: 18px; }
        }

        .toggle-knob {
            position: absolute;
            left: 4px;
            top: 4px;
            width: 54px;
            height: 22px;
            background: #ffffff;
            border-radius: 12px;
            transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        @media (min-width: 768px) {
            .toggle-knob { width: 74px; height: 26px; border-radius: 14px; }
        }

        .mode-toggle.theory .toggle-knob {
            transform: translateX(58px);
        }

        @media (min-width: 768px) {
            .mode-toggle.theory .toggle-knob { transform: translateX(78px); }
        }

        /* --- Game Area --- */
        #game-container {
            width: 100%;
            height: 100%;
            overflow: auto; 
            scrollbar-width: thin;
            scrollbar-color: #333 transparent;
            -webkit-overflow-scrolling: touch;
        }

        #game-svg {
            display: block;
            margin: 0 auto;
        }

        .node-circle {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .node-text {
            pointer-events: none;
            user-select: none;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 800;
        }

        @keyframes pulse-bright {
            0%, 100% { opacity: 0.6; stroke-width: 2px; }
            50% { opacity: 1; stroke-width: 5px; filter: drop-shadow(0 0 12px var(--accent)); }
        }

        .target-slot {
            fill: rgba(99, 102, 241, 0.2);
            stroke: #c7d2fe; 
            stroke-dasharray: 4;
            animation: pulse-bright 1.2s infinite;
        }

        /* --- Countdown UI --- */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .countdown-alert {
            animation: blink 0.5s infinite;
            color: var(--error);
        }

        /* --- Transitions --- */
        .view-pane {
            position: absolute;
            inset: 0;
            transition: opacity 0.4s ease;
        }

        .hidden-pane {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        /* --- Overlays --- */
        #game-over-overlay, #start-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            z-index: 1050; 
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        #game-over-overlay.visible, #start-overlay.visible {
            display: flex;
        }

        .bg-grain::after {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("https://grainy-gradients.vercel.app/noise.svg");
            opacity: 0.02;
            pointer-events: none;
            z-index: 100;
        }

        #notification {
            position: fixed;
            bottom: 3.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(120px);
            transition: transform 0.5s ease;
            z-index: 2000;
            width: calc(100% - 2rem);
            max-width: 320px;
        }
        #notification.active { transform: translateX(-50%) translateY(0); }

        /* Diagram Animations */
        .concept-diagram {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem 0;
            transition: all 0.3s ease;
        }

        @keyframes float-node {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .animate-node {
            animation: float-node 3s ease-in-out infinite;
        }

        .delay-1 { animation-delay: 0.5s; }
        .delay-2 { animation-delay: 1.2s; }

        @keyframes dash-scroll {
            to { stroke-dashoffset: -20; }
        }

        .connection-flow {
            stroke-dasharray: 5;
            animation: dash-scroll 2s linear infinite;
        }

        .reveal-theory {
            opacity: 0;
            transform: translateY(15px);
            transition: all 0.8s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .reveal-theory.active {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-grain">

    <!-- Simplified Global System Splash -->
    <div id="mode-splash">
        <div class="text-center">
            <h1 class="text-2xl font-black tracking-tighter text-white uppercase italic mb-2">BST STABILIZER</h1>
            <p id="splash-status" class="mono text-[10px] text-zinc-500 uppercase tracking-[0.4em]">LOADING_COMBAT...</p>
            <div class="splash-progress">
                <div class="splash-progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- Header HUD -->
    <header class="fixed top-0 w-full z-[1100] p-4 md:p-8 flex flex-col md:flex-row justify-between items-center gap-4 bg-black/95 backdrop-blur-2xl border-b border-white/5 shadow-2xl">
        <div class="flex items-center justify-between w-full md:w-auto gap-4">
            <div class="flex items-center gap-3">
                <button id="back-btn" class="w-8 h-8 glass rounded-lg flex items-center justify-center hover:bg-white/5 transition-colors shadow-lg">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg>
                </button>
                <div>
                    <h1 class="font-extrabold tracking-tighter uppercase text-[10px] md:text-xs text-white">BST_Stabilizer</h1>
                    <p id="level-display" class="mono text-[8px] md:text-[9px] text-zinc-500 uppercase">Sector_01 // Level_01</p>
                </div>
            </div>

            <!-- Mobile HUD Group -->
            <div class="md:hidden flex items-center gap-4">
                <div class="text-right">
                    <p class="text-[8px] mono text-zinc-500 uppercase leading-none mb-1">Score</p>
                    <p id="score-display-mobile" class="font-black text-xs text-white">0000</p>
                </div>
                <div class="relative w-10 h-10 glass rounded-full flex items-center justify-center border-indigo-500/30">
                    <svg viewBox="0 0 36 36" class="w-full h-full p-1 rotate-[-90deg]">
                        <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3" />
                        <circle id="timer-ring-mobile" cx="18" cy="18" r="16" fill="none" stroke="#6366f1" stroke-width="3" stroke-dasharray="100 100" />
                    </svg>
                    <div id="timer-countdown-mobile" class="absolute inset-0 flex items-center justify-center text-[7px] font-black mono text-indigo-400 hidden">--</div>
                </div>
            </div>
        </div>

        <!-- Mode Toggle -->
        <div class="flex items-center gap-3 md:gap-4">
            <span class="text-[8px] md:text-[9px] mono uppercase tracking-widest text-zinc-500">Combat</span>
            <div class="mode-toggle" id="view-toggle">
                <div class="toggle-knob"></div>
            </div>
            <span class="text-[8px] md:text-[9px] mono uppercase tracking-widest text-zinc-500">Theory</span>
        </div>

        <!-- Desktop Score & Timer -->
        <div class="hidden md:flex items-center gap-6">
            <div class="text-right">
                <p class="text-[9px] mono text-zinc-500 uppercase">Current_Score</p>
                <p id="score-display" class="font-black text-xl text-white">0000</p>
            </div>
            <div class="relative w-12 h-12 glass rounded-full flex items-center justify-center border-indigo-500/30">
                <svg viewBox="0 0 36 36" class="w-full h-full p-1 rotate-[-90deg]">
                    <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="2" />
                    <circle id="timer-ring" cx="18" cy="18" r="16" fill="none" stroke="#6366f1" stroke-width="2" stroke-dasharray="100 100" />
                </svg>
                <div id="timer-countdown" class="absolute inset-0 flex items-center justify-center text-[8px] font-black mono text-indigo-400 hidden">--</div>
            </div>
        </div>
    </header>

    <main class="relative flex-1 w-full h-screen">
        
        <!-- Combat View -->
        <section id="combat-pane" class="view-pane flex items-center justify-center p-4 md:p-6 pt-36 md:pt-32 pb-32 md:pb-40">
            <!-- Start Overlay -->
            <div id="start-overlay" class="visible">
                <div class="glass max-w-sm w-full p-8 md:p-12 rounded-[3rem] text-center space-y-8 border-t-4 border-t-indigo-500 shadow-2xl relative z-[600]">
                    <div class="space-y-2">
                        <h2 class="text-4xl font-black tracking-tighter uppercase italic text-white">Initialize</h2>
                        <p class="text-zinc-500 mono text-[9px] uppercase tracking-[0.3em]">BST_Stabilizer_Protocol_v.01</p>
                    </div>
                    <p class="text-xs text-zinc-400 leading-relaxed font-light">
                        Combat training sequence detected. Objective: Maintain tree stability by correctly placing incoming logical nodes.
                    </p>
                    <button id="begin-btn" class="w-full py-5 bg-white text-black rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-zinc-200 transition-all active:scale-95 shadow-xl shadow-white/5">
                        Begin Stabilization
                    </button>
                </div>
            </div>

            <div class="w-full h-full glass rounded-[2rem] md:rounded-[2.5rem] relative overflow-hidden flex flex-col">
                <div id="game-container" class="flex-1 w-full">
                    <svg id="game-svg" class="cursor-crosshair"></svg>
                </div>
                
                <!-- Tactical Mission Bar -->
                <div class="absolute bottom-0 w-full p-4 md:p-10 bg-gradient-to-t from-black to-transparent pointer-events-none z-[800]">
                    <div class="max-w-xl mx-auto glass rounded-xl md:rounded-2xl p-3 md:p-4 flex items-center justify-between gap-4 md:gap-6 border-l-4 border-l-indigo-500 pointer-events-auto shadow-2xl">
                        <div class="space-y-0.5 md:space-y-1">
                            <span class="text-[8px] md:text-[9px] mono text-indigo-400 font-bold uppercase tracking-widest">[MISSION]</span>
                            <p id="instruction-text" class="text-[10px] md:text-sm text-white font-medium">Insert <span id="target-value" class="bg-indigo-500/20 px-1.5 md:px-2 py-0.5 rounded text-indigo-400 font-black">--</span> into the stable BST.</p>
                        </div>
                        <div class="h-8 w-[1px] bg-white/10"></div>
                        <div class="text-right">
                            <span class="text-[7px] md:text-[8px] mono text-zinc-500 uppercase">Integrity</span>
                            <p id="integrity-text" class="text-[9px] md:text-[10px] font-bold text-emerald-500">100%</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Theory View -->
        <section id="theory-pane" class="view-pane hidden-pane overflow-y-auto px-6 pt-44 md:pt-48 pb-24">
            <div class="max-w-4xl mx-auto space-y-24">
                <!-- Introduction -->
                <div class="space-y-6 reveal-theory">
                    <div class="inline-flex items-center gap-3 px-3 py-1 bg-indigo-500/10 border border-indigo-500/30 rounded-full">
                        <span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
                        <span class="text-[10px] mono text-indigo-400 font-bold uppercase tracking-widest">Protocol_Decoding</span>
                    </div>
                    <h2 class="text-4xl md:text-6xl font-black tracking-tighter uppercase italic text-white">Binary Search Trees</h2>
                    <p class="text-zinc-500 text-base md:text-lg font-light leading-relaxed">
                        A Binary Search Tree (BST) is a hierarchical container designed for ultra-fast data retrieval. Imagine a <strong>smart library</strong> where every book tells you exactly which shelf to check next, eliminating half the library with every step.
                    </p>
                </div>

                <!-- The Golden Rule -->
                <div class="grid md:grid-cols-2 gap-12 items-start reveal-theory">
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold uppercase tracking-tight text-white border-l-4 border-indigo-500 pl-4">The Logic Rule</h3>
                        <p class="text-zinc-400 text-sm leading-relaxed">
                            For every node (the circle) in the Matrix:
                        </p>
                        <ul class="space-y-4">
                            <li class="flex items-start gap-3">
                                <span class="text-indigo-400 font-bold">1.</span>
                                <p class="text-sm text-zinc-300">Values in the <span class="text-indigo-400 font-bold">LEFT</span> subtree must be <span class="italic underline text-white">smaller</span> than the node.</p>
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-indigo-400 font-bold">2.</span>
                                <p class="text-sm text-zinc-300">Values in the <span class="text-indigo-400 font-bold">RIGHT</span> subtree must be <span class="italic underline text-white">larger</span> than the node.</p>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="concept-diagram flex flex-col items-center">
                        <p class="text-[9px] mono text-zinc-600 uppercase mb-6 tracking-widest">STABLE_TREE_STRUCTURE</p>
                        <svg viewBox="0 0 120 90" class="w-full max-w-[240px]">
                            <line x1="60" y1="15" x2="35" y2="45" stroke="rgba(255,255,255,0.1)" stroke-width="1.5" class="connection-flow"/>
                            <line x1="60" y1="15" x2="85" y2="45" stroke="rgba(255,255,255,0.1)" stroke-width="1.5" class="connection-flow"/>
                            <g class="animate-node">
                                <circle cx="60" cy="15" r="8" fill="#18181b" stroke="#6366f1" stroke-width="2" />
                                <text x="60" y="18" text-anchor="middle" fill="white" font-size="7" font-weight="bold">50</text>
                            </g>
                            <g class="animate-node delay-1">
                                <circle cx="35" cy="45" r="8" fill="#18181b" stroke="#22c55e" stroke-width="2" />
                                <text x="35" y="48" text-anchor="middle" fill="white" font-size="7" font-weight="bold">25</text>
                                <text x="35" y="65" text-anchor="middle" fill="#22c55e" font-size="6" font-weight="bold" class="uppercase tracking-widest">Smaller</text>
                            </g>
                            <g class="animate-node delay-2">
                                <circle cx="85" cy="45" r="8" fill="#18181b" stroke="#6366f1" stroke-width="2" />
                                <text x="85" y="48" text-anchor="middle" fill="white" font-size="7" font-weight="bold">75</text>
                                <text x="85" y="65" text-anchor="middle" fill="#6366f1" font-size="6" font-weight="bold" class="uppercase tracking-widest">Larger</text>
                            </g>
                        </svg>
                    </div>
                </div>

                <!-- Rule Validation Diagrams -->
                <div class="space-y-12 reveal-theory">
                    <h3 class="text-xl font-bold uppercase tracking-tight text-white border-l-4 border-indigo-500 pl-4">Validation Protocols</h3>
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Stable Node -->
                        <div class="concept-diagram flex flex-col items-center border-emerald-500/20 bg-emerald-500/5 group">
                            <div class="flex items-center gap-3 mb-6 w-full">
                                <svg class="w-5 h-5 text-emerald-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/></svg>
                                <h4 class="text-[10px] font-black uppercase text-emerald-500 tracking-[0.2em]">Stable Node Status</h4>
                            </div>
                            <svg viewBox="0 0 120 90" class="w-full max-w-[180px]">
                                <line x1="60" y1="20" x2="35" y2="55" stroke="rgba(34, 197, 94, 0.2)" stroke-width="2" />
                                <line x1="60" y1="20" x2="85" y2="55" stroke="rgba(34, 197, 94, 0.2)" stroke-width="2" />
                                <g class="animate-node">
                                    <circle cx="60" cy="20" r="10" fill="#09090b" stroke="#6366f1" stroke-width="2" />
                                    <text x="60" y="23" text-anchor="middle" fill="white" font-size="9" font-family="JetBrains Mono" font-weight="bold">40</text>
                                </g>
                                <g class="animate-node delay-1">
                                    <circle cx="35" cy="55" r="10" fill="#09090b" stroke="#22c55e" stroke-width="2" />
                                    <text x="35" y="58" text-anchor="middle" fill="white" font-size="9" font-family="JetBrains Mono" font-weight="bold">20</text>
                                </g>
                                <g class="animate-node delay-2">
                                    <circle cx="85" cy="55" r="10" fill="#09090b" stroke="#22c55e" stroke-width="2" />
                                    <text x="85" y="58" text-anchor="middle" fill="white" font-size="9" font-family="JetBrains Mono" font-weight="bold">60</text>
                                </g>
                            </svg>
                            <p class="mt-6 text-[10px] mono text-emerald-500 uppercase tracking-tighter font-black bg-emerald-500/10 px-3 py-1 rounded-full border border-emerald-500/20">VALID: 20 < 40 < 60</p>
                        </div>

                        <!-- Anomaly -->
                        <div class="concept-diagram flex flex-col items-center border-red-500/20 bg-red-500/5">
                            <div class="flex items-center gap-3 mb-6 w-full">
                                <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"/></svg>
                                <h4 class="text-[10px] font-black uppercase text-red-500 tracking-[0.2em]">Logic Anomaly Detected</h4>
                            </div>
                            <svg viewBox="0 0 140 100" class="w-full max-w-[200px] overflow-visible">
                                <line x1="70" y1="20" x2="45" y2="55" stroke="rgba(255,255,255,0.1)" stroke-width="2" />
                                <line x1="70" y1="20" x2="95" y2="55" stroke="#ef4444" stroke-width="2" stroke-dasharray="4" class="connection-flow"/>
                                <g>
                                    <circle cx="70" cy="20" r="10" fill="#09090b" stroke="#6366f1" stroke-width="2" />
                                    <text x="70" y="23" text-anchor="middle" fill="white" font-size="9" font-family="JetBrains Mono" font-weight="bold">40</text>
                                </g>
                                <g>
                                    <circle cx="45" cy="55" r="10" fill="#09090b" stroke="#6366f1" stroke-width="2" />
                                    <text x="45" y="58" text-anchor="middle" fill="white" font-size="9" font-family="JetBrains Mono" font-weight="bold">20</text>
                                </g>
                                <g>
                                    <circle cx="95" cy="55" r="10" fill="#09090b" stroke="#ef4444" stroke-width="2" class="shadow-xl" />
                                    <text x="95" y="58" text-anchor="middle" fill="#ef4444" font-size="9" font-family="JetBrains Mono" font-weight="bold">35</text>
                                    <g transform="translate(105, 45)">
                                        <circle cx="0" cy="0" r="5" fill="#ef4444" />
                                        <path d="M-2 -2 L2 2 M2 -2 L-2 2" stroke="white" stroke-width="1.2" />
                                    </g>
                                </g>
                            </svg>
                            <p class="mt-6 text-[10px] mono text-red-500 uppercase tracking-tighter font-black bg-red-500/10 px-3 py-1 rounded-full border border-red-500/20">35 is smaller than 40</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="w-full py-3 px-6 glass border-t border-white/5 flex justify-between items-center z-[50]">
        <div class="text-[8px] mono text-zinc-600 uppercase tracking-widest">
            &copy; 2024 DSA_MATRIX | RECOVERY_UNIT_01
        </div>
        <div class="text-[8px] mono text-indigo-500/50 uppercase tracking-[0.2em] animate-pulse">
            System_Live // Link_Stable
        </div>
    </footer>

    <!-- Game Over Modal -->
    <div id="game-over-overlay">
        <div class="glass max-w-sm w-full p-6 md:p-10 rounded-[2.5rem] md:rounded-[3rem] text-center space-y-6 md:space-y-8 border-t-4 border-t-indigo-500 shadow-2xl">
            <div class="space-y-2">
                <h2 class="text-3xl md:text-4xl font-black tracking-tighter uppercase italic text-white">Simulation Ended</h2>
                <p class="text-zinc-500 mono text-[8px] md:text-[9px] uppercase tracking-[0.3em]">Combat_Performance_Analysis</p>
            </div>

            <div class="grid grid-cols-2 gap-3 md:gap-4">
                <div class="bg-white/5 rounded-xl md:rounded-2xl p-3 md:p-4 border border-white/5">
                    <p class="text-[7px] md:text-[8px] mono text-zinc-500 uppercase mb-1">Final Score</p>
                    <p id="result-score" class="text-xl md:text-2xl font-black text-white">0000</p>
                </div>
                <div class="bg-white/5 rounded-xl md:rounded-2xl p-3 md:p-4 border border-white/5">
                    <p class="text-[7px] md:text-[8px] mono text-zinc-500 uppercase mb-1">Combat Precision</p>
                    <p id="result-accuracy" class="text-xl md:text-2xl font-black text-emerald-500">0%</p>
                </div>
                <div class="bg-white/5 rounded-xl md:rounded-2xl p-3 md:p-4 border border-white/5">
                    <p class="text-[7px] md:text-[8px] mono text-zinc-500 uppercase mb-1">Rank</p>
                    <p id="result-rank" class="text-[9px] md:text-xs font-black text-indigo-400 uppercase">Recruit</p>
                </div>
                <div class="bg-white/5 rounded-xl md:rounded-2xl p-3 md:p-4 border border-white/5">
                    <p class="text-[7px] md:text-[8px] mono text-zinc-500 uppercase mb-1">Highscore</p>
                    <p id="result-best" class="text-xl md:text-2xl font-black text-zinc-400">0000</p>
                </div>
            </div>

            <button id="restart-btn" class="w-full py-4 md:py-5 bg-white text-black rounded-xl md:rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-zinc-200 transition-all active:scale-95 shadow-xl shadow-white/5">
                Restart Simulation
            </button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="glass px-6 py-4 rounded-2xl flex items-center gap-4 border-l-4 border-l-indigo-500 shadow-2xl">
        <div id="notif-led" class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></div>
        <span id="notification-text" class="text-[9px] md:text-[10px] font-bold tracking-wider text-zinc-200 uppercase">Ready</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {firebaseConfig} from '../../script/base.js';


        // Environment Config
        //const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Game State
        let level = 1;
        let score = 0;
        let timeLeft = 100;
        let timerInterval = null;
        let tree = null;
        let targetValue = null;
        let currentUser = null;
        let correctMoves = 0;
        let totalMoves = 0;
        let totalSpeedScore = 0;
        let isSimulationRunning = false;
        let isGameOver = false;

        // UI Selectors
        const modeSplash = document.getElementById('mode-splash');
        const splashStatus = document.getElementById('splash-status');
        const viewToggle = document.getElementById('view-toggle');
        const combatPane = document.getElementById('combat-pane');
        const theoryPane = document.getElementById('theory-pane');
        const levelDisplay = document.getElementById('level-display');
        const scoreDisplays = [document.getElementById('score-display'), document.getElementById('score-display-mobile')];
        const timerRings = [document.getElementById('timer-ring'), document.getElementById('timer-ring-mobile')];
        const timerCountdowns = [document.getElementById('timer-countdown'), document.getElementById('timer-countdown-mobile')];
        const targetValueDisplay = document.getElementById('target-value');
        const gameSvg = document.getElementById('game-svg');
        const gameContainer = document.getElementById('game-container');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        const integrityText = document.getElementById('integrity-text');
        
        const startOverlay = document.getElementById('start-overlay');
        const gameOverOverlay = document.getElementById('game-over-overlay');
        const beginBtn = document.getElementById('begin-btn');
        const restartBtn = document.getElementById('restart-btn');

        const navigateTo = (path) => {
            const url = new URL(path, window.location.origin + window.location.pathname);
            window.location.assign(url.href);
        };

        class BSTNode {
            constructor(value, level = 0) {
                this.value = value;
                this.level = level;
                this.left = null;
                this.right = null;
            }
        }

        /**
         * Simplified Mode Splash
         */
        function triggerModeSplash(status, callback) {
            splashStatus.innerText = status;
            modeSplash.classList.add('active');
            
            setTimeout(() => {
                callback();
                setTimeout(() => {
                    modeSplash.classList.remove('active');
                }, 800);
            }, 500);
        }

        function getMaxDepth(node) {
            if (!node) return 0;
            return 1 + Math.max(getMaxDepth(node.left), getMaxDepth(node.right));
        }

        function generateLevel(levelNum) {
            const nodeCount = 3 + Math.floor(levelNum / 2);
            const values = [];
            while(values.length < nodeCount) {
                const r = Math.floor(Math.random() * 99) + 1;
                if(!values.includes(r)) values.push(r);
            }
            tree = new BSTNode(values[0], 0);
            for(let i = 1; i < values.length - 1; i++) insertNode(tree, values[i]);
            targetValue = values[values.length - 1];
            targetValueDisplay.innerText = targetValue;
            renderTree();
            startTimer();
        }

        function insertNode(root, val) {
            if(val < root.value) {
                if(!root.left) root.left = new BSTNode(val, root.level + 1);
                else insertNode(root.left, val);
            } else {
                if(!root.right) root.right = new BSTNode(val, root.level + 1);
                else insertNode(root.right, val);
            }
        }

        function renderTree() {
            gameSvg.innerHTML = '';
            const isMobile = window.innerWidth < 768;
            const containerWidth = gameContainer.clientWidth;
            const maxDepth = getMaxDepth(tree);
            const nodeRadius = isMobile ? 18 : 22;
            const vGap = isMobile ? 70 : 90;
            const leafNodesCount = Math.pow(2, maxDepth);
            const horizontalBuffer = nodeRadius * 5;
            const requiredWidth = Math.max(containerWidth, leafNodesCount * horizontalBuffer);
            const requiredHeight = (maxDepth + 2) * vGap + 120;
            gameSvg.setAttribute('width', requiredWidth);
            gameSvg.setAttribute('height', requiredHeight);
            const rootX = requiredWidth / 2;
            const rootY = 80;
            gameContainer.scrollLeft = (requiredWidth - containerWidth) / 2;
            function draw(node, x, y, currentHGap) {
                if(!node) return;
                const correctSide = targetValue < node.value ? 'left' : 'right';
                if(node.left) {
                    const lx = x - currentHGap;
                    const ly = y + vGap;
                    drawLine(x, y, lx, ly);
                    draw(node.left, lx, ly, currentHGap / 1.8);
                } else drawSlot(x - currentHGap, y + vGap, x, y, 'left', node, correctSide === 'left', nodeRadius);
                if(node.right) {
                    const rx = x + currentHGap;
                    const ry = y + vGap;
                    drawLine(x, y, rx, ry);
                    draw(node.right, rx, ry, currentHGap / 1.8);
                } else drawSlot(x + currentHGap, y + vGap, x, y, 'right', node, correctSide === 'right', nodeRadius);
                drawNode(x, y, node.value, nodeRadius);
            }
            draw(tree, rootX, rootY, requiredWidth / 4);
        }

        function drawLine(x1, y1, x2, y2) {
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", x1); line.setAttribute("y1", y1);
            line.setAttribute("x2", x2); line.setAttribute("y2", y2);
            line.setAttribute("stroke", "rgba(255,255,255,0.1)");
            line.setAttribute("stroke-width", "2");
            gameSvg.appendChild(line);
        }

        function drawNode(x, y, val, r) {
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", x); circle.setAttribute("cy", y); circle.setAttribute("r", r);
            circle.setAttribute("class", "node-circle fill-[#18181b] stroke-zinc-800");
            circle.setAttribute("stroke-width", "2");
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", x); text.setAttribute("y", y + (r/3.5));
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("class", "node-text fill-white");
            text.setAttribute("font-size", r * 0.65);
            text.textContent = val;
            g.appendChild(circle); g.appendChild(text);
            gameSvg.appendChild(g);
        }

        function drawSlot(x, y, px, py, side, parent, isCorrect, r) {
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.style.cursor = "pointer";
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", px); line.setAttribute("y1", py);
            line.setAttribute("x2", x); line.setAttribute("y2", y);
            line.setAttribute("stroke", "rgba(99, 102, 241, 0.2)");
            line.setAttribute("stroke-width", "1.5");
            line.setAttribute("stroke-dasharray", "4");
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", x); circle.setAttribute("cy", y); circle.setAttribute("r", r);
            circle.setAttribute("class", "target-slot");
            g.appendChild(line); g.appendChild(circle);
            g.onclick = (e) => { e.stopPropagation(); handleMove(isCorrect); };
            gameSvg.appendChild(g);
        }

        function handleMove(isCorrect) {
            totalMoves++;
            if(isCorrect) {
                correctMoves++;
                totalSpeedScore += timeLeft;
                notify("STABILIZING_SECTOR...", "success");
                score += Math.floor(timeLeft * level);
                level++;
                updateStatsUI();
                generateLevel(level);
            } else {
                notify("LOGIC_ERROR: INTEGRITY_DROP", "error");
                timeLeft = Math.max(0, timeLeft - 20); 
                updateStatsUI();
            }
        }

        function calculateAccuracy() {
            if (totalMoves === 0) return 100;
            const correctness = correctMoves / totalMoves;
            const speedFactor = (totalSpeedScore / Math.max(1, correctMoves)) / 100;
            return Math.round((correctness * 0.3 + speedFactor * 0.7) * 100);
        }

        function updateStatsUI() {
            const scoreStr = score.toString().padStart(4, '0');
            scoreDisplays.forEach(el => { if(el) el.innerText = scoreStr; });
            levelDisplay.innerText = `Sector_01 // Level_${level.toString().padStart(2, '0')}`;
            const acc = calculateAccuracy();
            integrityText.innerText = `${acc}%`;
            integrityText.className = `text-[9px] md:text-[10px] font-bold ${acc > 80 ? 'text-emerald-500' : acc > 50 ? 'text-yellow-500' : 'text-red-500'}`;
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 100;
            isSimulationRunning = true;
            timerInterval = setInterval(() => {
                timeLeft -= (0.35 + (level * 0.1));
                timerRings.forEach(el => { if(el) el.style.strokeDasharray = `${Math.max(0, timeLeft)} 100`; });
                if(timeLeft < 30) {
                    const secs = Math.max(0, Math.ceil(timeLeft / 10));
                    timerCountdowns.forEach(el => {
                        if(el) {
                            el.innerText = secs > 0 ? secs : "FAIL";
                            el.classList.remove('hidden');
                            el.classList.add('countdown-alert');
                        }
                    });
                } else timerCountdowns.forEach(el => { if(el) el.classList.add('hidden'); });
                if(timeLeft <= 0) gameOver();
            }, 100);
        }

        async function gameOver() {
            isSimulationRunning = false;
            isGameOver = true;
            clearInterval(timerInterval);
            notify("CRITICAL_FAILURE // OVERFLOW", "error");
            timerCountdowns.forEach(el => { if(el) { el.innerText = "OVER"; el.classList.remove('hidden'); } });
            const acc = calculateAccuracy();
            let rank = score > 15000 ? "Matrix_Overlord" : score > 5000 ? "System_Specialist" : "Logic_Cadet";
            document.getElementById('result-score').innerText = score.toString().padStart(4, '0');
            document.getElementById('result-accuracy').innerText = `${acc}%`;
            document.getElementById('result-rank').innerText = rank;
            let highscore = 0;
            if(currentUser) {
                try {
                    const profileRef = doc(db, 'artifacts', currentUser.uid, 'profile', 'data');
                    const snap = await getDoc(profileRef);
                    if(snap.exists()) {
                        const data = snap.data();
                        highscore = data.scores?.bst || 0;
                        if(score > highscore) {
                            highscore = score;
                            const newScores = { ...data.scores, bst: highscore };
                            await updateDoc(profileRef, { scores: newScores });
                            const sessionData = JSON.parse(localStorage.getItem('matrix_user_session') || '{}');
                            sessionData.scores = newScores;
                            localStorage.setItem('matrix_user_session', JSON.stringify(sessionData));
                            notify("NEW_HIGHSCORE_RECORDED", "success");
                        }
                    }
                } catch(e) { console.error("Sync Failure:", e); }
            }
            document.getElementById('result-best').innerText = highscore.toString().padStart(4, '0');
            gameOverOverlay.classList.add('visible');
        }

        function resetGame() {
            level = 1; score = 0; correctMoves = 0; totalMoves = 0; totalSpeedScore = 0; isGameOver = false;
            updateStatsUI();
            gameOverOverlay.classList.remove('visible');
            startOverlay.classList.remove('visible');
            generateLevel(level);
        }

        function notify(message, type = "status") {
            notificationText.innerText = message;
            const led = document.getElementById('notif-led');
            led.className = `w-2 h-2 rounded-full animate-pulse ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-emerald-500' : 'bg-indigo-500'}`;
            notification.classList.add('active');
            setTimeout(() => notification.classList.remove('active'), 3000);
        }

        viewToggle.onclick = () => {
            const isTheory = viewToggle.classList.toggle('theory');
            const status = isTheory ? "LOADING_THEORY..." : "LOADING_COMBAT...";
            
            triggerModeSplash(status, () => {
                if(isTheory) {
                    combatPane.classList.add('hidden-pane');
                    theoryPane.classList.remove('hidden-pane');
                    clearInterval(timerInterval);
                    gameOverOverlay.classList.remove('visible');
                    startOverlay.classList.remove('visible');
                    triggerReveal();
                } else {
                    combatPane.classList.remove('hidden-pane');
                    theoryPane.classList.add('hidden-pane');
                    if (isGameOver) gameOverOverlay.classList.add('visible');
                    else if (!isSimulationRunning) startOverlay.classList.add('visible');
                    else startTimer();
                }
            });
        };

        function triggerReveal() {
            const reveals = document.querySelectorAll('.reveal-theory');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('active'); });
            }, { threshold: 0.1 });
            reveals.forEach(r => observer.observe(r));
        }

        beginBtn.onclick = resetGame;
        restartBtn.onclick = resetGame;
        document.getElementById('back-btn').onclick = () => navigateTo('../index.html');

        onAuthStateChanged(auth, (user) => {
            if(user) { 
                currentUser = user;
                triggerModeSplash("INITIALIZING...", () => {
                    startOverlay.classList.add('visible');
                });
            } else navigateTo('../../auth/index.html');
        });

        window.onresize = () => renderTree();
    </script>
</body>
</html>