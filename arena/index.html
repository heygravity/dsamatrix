<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arena Hub | DSA Matrix</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='25' fill='%236366f1'/><circle cx='50' cy='50' r='20' fill='white' opacity='0.5'/><circle cx='25' cy='25' r='10' fill='white' opacity='0.5'/><circle cx='75' cy='75' r='10' fill='white' opacity='0.5'/></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --surface: #111111;
            --accent: #6366f1;
            --error: #ef4444;
            --border: rgba(255, 255, 255, 0.08);
            --chip-body: #18181b;
            --pin-color: #3f3f46;
        }

        body {
            background-color: var(--bg);
            color: #efefef;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .glass {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
        }

        /* --- Global Splash Overlay (Parity with Auth) --- */
        #global-splash {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 5000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        #global-splash.active { display: flex; }

        .splash-loader {
            height: 1px;
            width: 140px;
            background: rgba(255,255,255,0.1);
            margin-top: 1.5rem;
            overflow: hidden;
        }

        .splash-progress {
            height: 100%;
            width: 100%;
            background: white;
            transform-origin: left;
            transform: scaleX(0);
        }

        .active .splash-progress {
            animation: load-bar 1.5s cubic-bezier(0.65, 0, 0.35, 1) infinite;
        }

        @keyframes load-bar {
            0% { transform: scaleX(0); }
            50% { transform: scaleX(1); }
            100% { transform: scaleX(0); transform-origin: right; }
        }

        /* --- Protocol Menu --- */
        .protocol-menu {
            position: relative;
            display: inline-block;
        }

        .protocol-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            z-index: 100;
        }

        @media (min-width: 1024px) {
            .protocol-menu:hover .protocol-dropdown {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }
        }

        .protocol-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* --- Modal Architecture --- */
        #confirmation-modal, #edit-modal {
            position: fixed;
            inset: 0;
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        #confirmation-modal {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(15px);
        }

        #edit-modal {
            background: rgba(0, 0, 0, 0.1); 
            backdrop-filter: blur(12px);
        }

        #confirmation-modal.active, #edit-modal.active {
            display: flex;
        }

        #edit-card {
            background: #000000 !important; 
            border: 1px solid var(--border);
        }

        /* --- Form Styling --- */
        input {
            background: rgba(255, 255, 255, 0.03) !important;
            border: 1px solid var(--border) !important;
            transition: all 0.3s ease;
            color: white;
        }

        input:focus {
            border-color: var(--accent) !important;
            background: rgba(255, 255, 255, 0.06) !important;
            outline: none;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.1);
        }

        input.invalid { border-color: var(--error) !important; }

        .error-msg {
            color: var(--error);
            font-size: 9px;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 4px;
            margin-left: 4px;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .error-msg.visible { opacity: 1; transform: translateY(0); }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .error-shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }

        /* --- Logic Chip Card Design --- */
        .logic-chip {
            position: relative;
            width: 100%;
            background: var(--chip-body);
            border-radius: 4px;
            padding: 20px;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: pointer;
            border: 1px solid #27272a;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .logic-chip::before, .logic-chip::after {
            content: "";
            position: absolute;
            left: -6px;
            top: 20%;
            bottom: 20%;
            width: 6px;
            background-image: linear-gradient(to bottom, 
                var(--pin-color) 0%, var(--pin-color) 15%, 
                transparent 15%, transparent 25%,
                var(--pin-color) 25%, var(--pin-color) 40%,
                transparent 40%, transparent 50%,
                var(--pin-color) 50%, var(--pin-color) 65%,
                transparent 65%, transparent 75%,
                var(--pin-color) 75%, var(--pin-color) 90%,
                transparent 90%);
            background-size: 100% 40px;
        }

        .logic-chip::after { left: auto; right: -6px; }

        .chip-surface {
            position: relative;
            background: #09090b;
            border: 1px solid #27272a;
            border-radius: 2px;
            padding: 12px;
            height: 100px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .circuit-lines {
            position: absolute;
            inset: 0;
            opacity: 0.1;
            background-image: 
                radial-gradient(var(--accent) 1px, transparent 1px),
                linear-gradient(to right, #27272a 1px, transparent 1px),
                linear-gradient(to bottom, #27272a 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
        }

        .logic-chip:hover {
            transform: translateY(-8px) scale(1.01);
            border-color: var(--accent);
            box-shadow: 0 20px 40px -10px rgba(99, 102, 241, 0.3);
        }

        .led { width: 4px; height: 4px; border-radius: 50%; background: #3f3f46; transition: all 0.3s ease; }
        .logic-chip:hover .led.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

        /* Specialist Avatar */
        .avatar-frame {
            position: relative;
            padding: 4px;
            background: linear-gradient(135deg, var(--accent), transparent);
            border-radius: 50%;
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .avatar-inner {
            width: 100px;
            height: 100px;
            background: #09090b;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #18181b;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bg-grain::after {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("https://grainy-gradients.vercel.app/noise.svg");
            opacity: 0.02;
            pointer-events: none;
            z-index: 100;
        }

        #notification {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(120px);
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            z-index: 1000;
            width: calc(100% - 2rem);
            max-width: 400px;
        }

        #notification.active { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="bg-grain">

    <!-- Global Splash Screen -->
    <div id="global-splash">
        <div class="text-center">
            <h2 id="splash-title" class="text-xl font-black tracking-[0.4em] uppercase italic text-white mb-2">Synchronizing</h2>
            <p id="splash-desc" class="mono text-[8px] text-zinc-600 uppercase tracking-[0.3em]">Checking_System_Status</p>
            <div class="splash-loader mx-auto">
                <div class="splash-progress"></div>
            </div>
        </div>
    </div>

    <!-- Header Navigation -->
    <nav class="p-4 md:p-8 flex justify-between items-center max-w-7xl mx-auto relative z-20">
        <div class="flex items-center gap-2 md:gap-3">
            <div class="w-7 h-7 md:w-8 md:h-8 bg-white rounded-lg flex items-center justify-center rotate-3 shadow-lg shadow-white/5">
                <svg class="w-4 h-4 text-black" fill="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            </div>
            <span class="font-extrabold tracking-tighter uppercase text-[10px] md:text-sm text-white">Matrix Arena Hub</span>
        </div>
        
        <div class="protocol-menu">
            <button id="menu-trigger" class="flex items-center gap-2 text-[9px] md:text-[10px] mono uppercase tracking-widest text-zinc-500 hover:text-white transition-colors p-2 bg-white/5 rounded-lg border border-white/5">
                System_Protocol
                <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div id="protocol-dropdown" class="protocol-dropdown glass p-2 rounded-xl border border-white/10 shadow-2xl">
                <button id="edit-trigger" class="w-full text-left px-4 py-3 rounded-lg text-[9px] mono uppercase tracking-widest text-zinc-400 hover:text-white hover:bg-white/5 transition-all">
                    Edit_Registry
                </button>
                <button id="logout-btn" class="w-full text-left px-4 py-3 rounded-lg text-[9px] mono uppercase tracking-widest text-zinc-400 hover:text-white hover:bg-white/5 transition-all">
                    Terminate_Session
                </button>
                <div class="h-[1px] w-full bg-white/5 my-1"></div>
                <button id="delete-trigger" class="w-full text-left px-4 py-3 rounded-lg text-[9px] mono uppercase tracking-widest text-red-500 hover:text-white hover:bg-red-500/10 transition-all">
                    Purge_Identity
                </button>
            </div>
        </div>
    </nav>

    <!-- Account Edit Modal -->
    <div id="edit-modal">
        <div id="edit-card" class="p-8 md:p-10 rounded-[3rem] w-full max-w-md mx-6 space-y-6 overflow-y-auto max-h-[90vh] shadow-2xl border-t border-white/10">
            <div class="text-center">
                <h2 class="text-xl font-black tracking-tighter uppercase italic text-white">Registry Modification</h2>
                <p class="text-zinc-500 text-[9px] mono uppercase tracking-[0.3em]">Updating_Identity_Parameters</p>
            </div>
            
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[9px] uppercase tracking-widest text-zinc-500 font-bold ml-1">Specialist Name</label>
                    <input type="text" id="edit-name" class="w-full rounded-2xl px-6 py-4 bg-zinc-900 border border-zinc-800 text-sm" placeholder="John Doe">
                    <p id="error-name" class="error-msg">Require First & Last Name</p>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] uppercase tracking-widest text-zinc-500 font-bold ml-1">Date of Birth (DD-MM-YYYY)</label>
                    <input type="text" id="edit-dob" maxlength="10" class="w-full rounded-2xl px-6 py-4 bg-zinc-900 border border-zinc-800 text-sm mono" placeholder="15-08-1995">
                    <p id="error-dob" class="error-msg">Age must be between 12 and 100</p>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] uppercase tracking-widest text-zinc-500 font-bold ml-1">Secure Email</label>
                    <input type="email" id="edit-email" class="w-full rounded-2xl px-6 py-4 bg-zinc-900 border border-zinc-800 text-sm" placeholder="recruit@matrix.io">
                    <p id="error-email" class="error-msg">Invalid transmission format</p>
                </div>
            </div>

            <div class="flex flex-col gap-3 pt-4">
                <button id="save-edit" class="w-full py-5 bg-white text-black rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-zinc-200 transition-all shadow-xl active:scale-95">
                    Commit Changes
                </button>
                <button id="cancel-edit" class="w-full py-4 text-zinc-500 text-[10px] font-bold uppercase tracking-widest hover:text-white transition-colors">
                    Discard_Protocol
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal">
        <div class="glass max-w-sm w-full p-8 md:p-10 rounded-[2.5rem] border-t-4 border-t-red-500 shadow-2xl space-y-8 text-center">
            <div class="space-y-2">
                <h2 class="text-2xl font-black tracking-tighter uppercase italic text-white">Identity Purge</h2>
                <p class="text-red-400 mono text-[10px] uppercase tracking-[0.3em]">Warning: Critical_Decision</p>
            </div>
            <div class="bg-red-500/5 border border-red-500/20 p-4 rounded-2xl text-xs text-zinc-400 leading-relaxed text-left">
                Confirming this protocol will <span class="text-white font-bold">permanently delete all combat data</span>, highscores, and registry credentials.
            </div>
            <div class="flex flex-col gap-3">
                <button id="confirm-delete" class="w-full py-4 bg-red-500 text-white rounded-2xl font-black uppercase text-[10px] tracking-[0.3em] hover:bg-red-600 transition-all active:scale-95">
                    Execute Purge
                </button>
                <button id="cancel-delete" class="w-full py-4 bg-white/5 text-zinc-500 rounded-2xl font-bold uppercase text-[10px] tracking-[0.2em] hover:text-white transition-all">
                    Abort Protocol
                </button>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 md:px-8 py-8 md:py-12">
        <!-- Profile Section -->
        <section id="profile-display" class="flex flex-col md:flex-row items-center md:items-end gap-6 md:gap-8 mb-16 md:mb-24 opacity-0 transition-all duration-1000 transform translate-y-4">
            <div class="avatar-frame">
                <div class="avatar-inner">
                    <svg viewBox="0 0 100 100" class="w-full h-full">
                        <circle cx="50" cy="50" r="48" fill="rgba(99, 102, 241, 0.05)" />
                        <path d="M50 30 C 40 30, 35 35, 35 45 C 35 55, 40 60, 50 60 C 60 60, 65 55, 65 45 C 65 35, 60 30, 50 30 Z" fill="#27272a" />
                        <path d="M25 85 C 25 70, 35 65, 50 65 C 65 65, 75 70, 75 85" fill="none" stroke="#6366f1" stroke-width="2" stroke-linecap="round" />
                        <circle cx="50" cy="45" r="8" fill="#6366f1" opacity="0.8" />
                    </svg>
                </div>
            </div>

            <div class="text-center md:text-left space-y-4 md:space-y-5 flex-1">
                <div class="space-y-1">
                    <p class="text-[8px] md:text-[9px] mono text-zinc-500 uppercase tracking-[0.4em]">Identity_Verified_Protocol</p>
                    <h1 id="display-name" class="text-2xl sm:text-3xl md:text-5xl lg:text-6xl font-extrabold tracking-tighter uppercase italic text-white break-words">RECRUIT_NAME</h1>
                </div>

                <div class="flex flex-wrap justify-center md:justify-start gap-3 md:gap-4">
                    <div class="glass px-4 md:px-5 py-2 md:py-2.5 rounded-xl text-[8px] md:text-[9px] mono text-zinc-400 uppercase border-white/5 flex items-center gap-2">
                        <div id="role-icon"></div>
                        ROLE: <span id="display-role" class="text-indigo-400 font-bold">---</span>
                    </div>
                    <div class="glass px-4 md:px-5 py-2 md:py-2.5 rounded-xl text-[8px] md:text-[9px] mono text-zinc-400 uppercase border-white/5 whitespace-nowrap">
                        DOB: <span id="display-dob" class="text-white">--/--/----</span>
                    </div>
                    <div class="bg-indigo-500/10 border border-indigo-500/30 px-4 md:px-5 py-2 md:py-2.5 rounded-xl text-[8px] md:text-[9px] mono text-indigo-400 uppercase">
                        COMBAT_EXP: <span id="display-total-exp" class="text-white font-black">0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Module Grid -->
        <section class="space-y-8 md:space-y-12">
            <div class="flex items-center gap-4 md:gap-6">
                <h2 class="text-[9px] md:text-[10px] mono text-zinc-600 uppercase tracking-[0.6em]">Logic_Combat_Modules</h2>
                <div class="h-[1px] flex-1 bg-zinc-900"></div>
            </div>
            <div id="module-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 md:gap-10"></div>
        </section>
    </main>

    <!-- Notification -->
    <div id="notification" class="glass px-6 py-4 rounded-2xl flex items-center gap-4 border-l-4 border-l-indigo-500 min-w-[280px] max-w-[90%] shadow-2xl">
        <div id="notif-led" class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></div>
        <span id="notification-text" class="text-[10px] font-bold tracking-wider text-zinc-200 uppercase">Arena Connected</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {firebaseConfig} from '../script/base.js';

        //const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Selectors
        const globalSplash = document.getElementById('global-splash');
        const splashTitle = document.getElementById('splash-title');
        const splashDesc = document.getElementById('splash-desc');

        const menuTrigger = document.getElementById('menu-trigger');
        const dropdown = document.getElementById('protocol-dropdown');
        const logoutBtn = document.getElementById('logout-btn');
        const deleteTrigger = document.getElementById('delete-trigger');
        const confirmModal = document.getElementById('confirmation-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete'); 
        const cancelDeleteBtn = document.getElementById('cancel-delete');   
        const editModal = document.getElementById('edit-modal');
        const editTrigger = document.getElementById('edit-trigger');
        
        const displayName = document.getElementById('display-name');
        const displayDob = document.getElementById('display-dob');
        const displayRole = document.getElementById('display-role');
        const displayTotalExp = document.getElementById('display-total-exp');
        const profileSection = document.getElementById('profile-display');
        const moduleGrid = document.getElementById('module-grid');
        const notificationText = document.getElementById('notification-text');

        const editName = document.getElementById('edit-name');
        const editDob = document.getElementById('edit-dob');
        const editEmail = document.getElementById('edit-email');
        const saveEditBtn = document.getElementById('save-edit');
        const cancelEditBtn = document.getElementById('cancel-edit');

        // --- System Logic Helpers ---
        function showSplash(title, desc) {
            splashTitle.innerText = title;
            splashDesc.innerText = desc;
            globalSplash.classList.add('active');
        }
        function hideSplash() { globalSplash.classList.remove('active'); }

        const ROLE_CONFIG = {
            'cs_student': { label: 'CS_STUDENT', icon: `<svg class="w-3 h-3 text-indigo-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L1 7l11 5 11-5-11-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>` },
            'engineering_student': { label: 'ENG_STUDENT', icon: `<svg class="w-3 h-3 text-indigo-400" fill="currentColor" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6-3.8 3.8L11 11.5a1 1 0 0 0-1.4 0l-4 4a1 1 0 0 0 1.4 1.4l3.3-3.3 1.5 1.5a1 1 0 0 0 1.4 0l4.5-4.5 1.6 1.6a1 1 0 0 0 1.4-1.4l-3-3a1 1 0 0 0-1.4 0z"/></svg>` },
            'software_dev': { label: 'SW_ARCHITECT', icon: `<svg class="w-3 h-3 text-indigo-400" fill="currentColor" viewBox="0 0 24 24"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>` },
            'competitive_prog': { label: 'LOGIC_COMBATANT', icon: `<svg class="w-3 h-3 text-indigo-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>` },
            'dsa_educator': { label: 'SYSTEM_INSTRUCTOR', icon: `<svg class="w-3 h-3 text-indigo-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>` },
            'hobbyist': { label: 'SPECIALIST', icon: `<svg class="w-3 h-3 text-indigo-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14.5v-9l6 4.5-6 4.5z"/></svg>` },
            'other': { label: 'UNCLASSIFIED', icon: `<svg class="w-3 h-3 text-indigo-400" fill="currentColor" viewBox="0 0 24 24"><path d="M11 15h2v2h-2zm0-8h2v6h-2zM12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>` }
        };

        const MODULE_REGISTRY = [
            { id: 'bst', title: 'BST_Stabilizer', concept: 'Hierarchical Trees', active: true, url: 'bst_stabilizer/index.html', graphic: `<svg viewBox="0 0 100 60" class="w-full h-12"><path d="M50 10 L30 35 M50 10 L70 35" stroke="currentColor" stroke-width="1.5" /><circle cx="50" cy="10" r="5" fill="currentColor"/><circle cx="30" cy="35" r="5" fill="currentColor" opacity="0.4"/><circle cx="70" cy="35" r="5" fill="#6366f1"/></svg>` },
            { id: 'list', title: 'Chain_Persist', concept: 'Linked Lists', active: false, graphic: `<svg viewBox="0 0 100 60" class="w-full h-10"><rect x="10" y="25" width="15" height="10" rx="1" fill="currentColor"/><rect x="42.5" y="25" width="15" height="10" rx="1" fill="currentColor"/><rect x="75" y="25" width="15" height="10" rx="1" fill="currentColor"/><path d="M25 30 L42.5 30 M57.5 30 L75 30" stroke="currentColor" stroke-width="2" stroke-dasharray="2"/></svg>` },
            { id: 'graph', title: 'Path_Navigator', concept: 'Graph Networks', active: false, graphic: `<svg viewBox="0 0 100 60" class="w-full h-10"><circle cx="20" cy="15" r="4" fill="currentColor"/><circle cx="80" cy="15" r="4" fill="currentColor"/><circle cx="50" cy="45" r="4" fill="currentColor"/><path d="M24 15 L76 15 M23 18 L47 43 M77 18 L53 43" stroke="currentColor" stroke-width="1" opacity="0.3"/></svg>` },
            { id: 'stack', title: 'Stack_Overflow', concept: 'LIFO Buffers', active: false, graphic: `<svg viewBox="0 0 100 60" class="w-full h-10"><rect x="35" y="10" width="30" height="6" fill="#6366f1"/><rect x="35" y="20" width="30" height="6" fill="currentColor" opacity="0.6"/><rect x="35" y="30" width="30" height="6" fill="currentColor" opacity="0.3"/><path d="M30 5 V 45 H 70 V 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>` }
        ];

        // --- Validation Logic ---
        const validators = {
            name: (val) => val.trim().split(' ').length >= 2,
            email: (val) => !val || /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(val),
            dob: (val) => {
                if (!/^\d{2}-\d{2}-\d{4}$/.test(val)) return false;
                const [d, m, y] = val.split('-').map(Number);
                const age = new Date().getFullYear() - y;
                return age >= 12 && age <= 100;
            }
        };

        function validateEditForm() {
            const isNameOk = validators.name(editName.value);
            const isDobOk = validators.dob(editDob.value);
            const isEmailOk = validators.email(editEmail.value);
            document.getElementById('error-name').classList.toggle('visible', !isNameOk && editName.value.length > 0);
            document.getElementById('error-dob').classList.toggle('visible', !isDobOk && editDob.value.length === 10);
            document.getElementById('error-email').classList.toggle('visible', !isEmailOk && editEmail.value.length > 0);
            saveEditBtn.disabled = !(isNameOk && isDobOk && isEmailOk);
        }

        menuTrigger.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('active'); });
        document.addEventListener('click', () => dropdown.classList.remove('active'));

        editTrigger.addEventListener('click', () => {
            const data = JSON.parse(localStorage.getItem('matrix_user_session'));
            if (data) {
                editName.value = data.name || "";
                editDob.value = data.dob || "";
                editEmail.value = data.email || "";
                validateEditForm();
            }
            editModal.classList.add('active');
        });

        cancelEditBtn.addEventListener('click', () => editModal.classList.remove('active'));

        function notify(message, type = 'status') {
            notificationText.innerText = message;
            const led = document.getElementById('notif-led');
            if (led) led.className = `w-2 h-2 rounded-full ${type === 'error' ? 'bg-red-500' : 'bg-indigo-500'} animate-pulse`;
            document.getElementById('notification').classList.add('active');
            if (type === 'error') {
                const target = editModal.classList.contains('active') ? document.getElementById('edit-card') : document.body;
                target.classList.add('error-shake');
                setTimeout(() => target.classList.remove('error-shake'), 400);
            }
            setTimeout(() => document.getElementById('notification').classList.remove('active'), 4000);
        }

        const navigateTo = (path) => window.location.assign(new URL(path, window.location.origin + window.location.pathname).href);

        [editName, editDob, editEmail].forEach(el => el.addEventListener('input', validateEditForm));

        editDob.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 2 && val.length <= 4) val = val.slice(0, 2) + '-' + val.slice(2);
            if (val.length > 4) val = val.slice(0, 2) + '-' + val.slice(2, 4) + '-' + val.slice(4, 8);
            e.target.value = val;
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const cached = localStorage.getItem('matrix_user_session');
                if (cached) {
                    const data = JSON.parse(cached);
                    if (data.uid === user.uid) updateProfileUI(data);
                }
                await fetchRegistryData(user.uid);
            } else navigateTo('../auth/index.html');
        });

        async function fetchRegistryData(uid) {
            try {
                showSplash("SYNCHRONIZING", "Retrieving_Profile_Buffers...");
                const profileRef = doc(db, 'artifacts', uid, 'profile', 'data');
                const snap = await getDoc(profileRef);
                if (snap.exists()) {
                    let data = snap.data();
                    updateProfileUI(data);
                    localStorage.setItem('matrix_user_session', JSON.stringify({ uid, ...data }));
                } else navigateTo('../auth/index.html');
                hideSplash();
            } catch (err) { 
                notify("ERR: LOG_SYNC_INTERRUPTED", "error"); 
                hideSplash();
            }
        }

        function updateProfileUI(data) {
            displayName.innerText = data.name || "LOGIC_CADET";
            displayDob.innerText = data.dob || "--/--/----";
            const roleInfo = ROLE_CONFIG[data.role] || ROLE_CONFIG.other;
            displayRole.innerText = roleInfo.label;
            document.getElementById('role-icon').innerHTML = roleInfo.icon;
            const scores = data.scores || {};
            displayTotalExp.innerText = Object.values(scores).reduce((a, b) => Number(a) + Number(b), 0);
            renderChips(scores);
            profileSection.classList.remove('opacity-0', 'translate-y-4');
            profileSection.classList.add('opacity-100', 'translate-y-0');
        }

        function renderChips(scores) {
            moduleGrid.innerHTML = '';
            MODULE_REGISTRY.forEach((mod, index) => {
                const score = scores[mod.id] || 0;
                const chip = document.createElement('div');
                chip.className = `logic-chip group ${!mod.active ? 'opacity-60 grayscale-[0.5]' : ''}`;
                chip.innerHTML = `
                    <div class="flex justify-between items-start"><div class="flex gap-1"><div class="led active bg-zinc-600"></div><div class="led ${mod.active ? 'active' : ''}"></div></div><span class="text-[8px] mono text-zinc-600">REV.0${index + 1}</span></div>
                    <div class="chip-surface"><div class="circuit-lines"></div><div class="relative z-10 text-zinc-400 group-hover:text-white transition-colors h-full flex items-center justify-center">${mod.graphic}</div></div>
                    <div class="space-y-1 relative z-10"><h3 class="text-[10px] font-black uppercase tracking-tighter text-white">${mod.title}</h3><p class="text-[7px] mono text-zinc-500 uppercase">${mod.concept}</p></div>
                    <div class="flex justify-between items-end border-t border-zinc-800 pt-3 mt-1"><div class="flex flex-col"><span class="text-[7px] mono text-zinc-600 uppercase">Highscore</span><span class="text-[10px] font-black text-indigo-400">${score}</span></div><div class="w-6 h-6 rounded bg-zinc-800 flex items-center justify-center group-hover:bg-indigo-600 transition-colors">${mod.active ? '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' : '<svg class="w-3 h-3 text-zinc-600" fill="currentColor" viewBox="0 0 24 24"><path d="M18 8V7a4 4 0 00-8 0v1H5v11h14V8h-1zm-6-3a2 2 0 012 2v1h-4V7a2 2 0 012-2z"/></svg>'}</div></div>
                `;
                chip.onclick = () => mod.active ? navigateTo(mod.url) : notify(`NOTICE: ${mod.title} UNDER ENCRYPTION`);
                moduleGrid.appendChild(chip);
            });
        }

        saveEditBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            showSplash("ENCRYPTING", "Syncing_Registry_Updates...");
            try {
                const profileRef = doc(db, 'artifacts', user.uid, 'profile', 'data');
                const updatedData = { name: editName.value.trim(), dob: editDob.value, email: editEmail.value.trim() || null };
                await updateDoc(profileRef, updatedData);
                const session = JSON.parse(localStorage.getItem('matrix_user_session'));
                localStorage.setItem('matrix_user_session', JSON.stringify({ ...session, ...updatedData }));
                updateProfileUI({ ...session, ...updatedData });
                editModal.classList.remove('active');
                notify("REGISTRY_UPDATED // SYNC_SUCCESS");
            } catch (err) { notify("ERR: COMMIT_FAILED", "error"); }
            finally { hideSplash(); }
        });

        logoutBtn.onclick = async () => {
            showSplash("TERMINATING", "Closing_Matrix_Protocol...");
            await signOut(auth);
            localStorage.removeItem('matrix_user_session');
            setTimeout(() => navigateTo('./index.html'), 1000);
        };

        deleteTrigger.onclick = () => {
            dropdown.classList.remove('active');
            confirmModal.classList.add('active');
        };

        cancelDeleteBtn.onclick = () => confirmModal.classList.remove('active');

        confirmDeleteBtn.onclick = async () => {
            const user = auth.currentUser;
            if (!user) return;
            confirmModal.classList.remove('active');
            showSplash("PURGING", "Erasing_Identity_Registry...");
            try {
                const profileRef = doc(db, 'artifacts', user.uid, 'profile', 'data');
                await deleteDoc(profileRef);
                try {
                    await deleteUser(user);
                    notify("PROTOCOL: IDENTITY_PURGED", "error");
                } catch (authErr) {
                    await signOut(auth);
                    notify("DATA_ERASED // RE-AUTH_FAIL_SIGNED_OUT", "error");
                }
                localStorage.removeItem('matrix_user_session');
                setTimeout(() => navigateTo('../auth/index.html'), 1500);
            } catch (err) {
                hideSplash();
                notify("ERR: DATA_PURGE_INTERRUPTED", "error");
            }
        };
    </script>
</body>
</html>